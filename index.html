<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Daily Dose of Positivity</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #280137; /* Midnight Purple (Near Black) */
            display: flex;
            justify-content: center;
            padding: 20px;
            min-height: 100vh;
        }
        .message-card {
            /* Magical gradient: Soft Violet to Electric Blue */
            background: linear-gradient(135deg, #a29bfe 0%, #6c5ce7 100%); 
            border: 1px solid #6c5ce7; /* Violet border */
            /* Deep, soft shadow */
            box-shadow: 0 15px 30px -10px rgba(108, 92, 231, 0.6), 0 4px 6px -2px rgba(0, 0, 0, 0.1);
        }
        .list-item:hover {
            box-shadow: 0 4px 6px -1px rgba(255, 255, 255, 0.1);
            transform: translateY(-1px);
        }
    </style>
    <!-- Firebase Imports -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, deleteDoc, setDoc, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // IMPORTANT: These global variables are provided by the canvas environment.
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        const USER_FIREBASE_CONFIG = {
          apiKey: "AIzaSyBPvb94wCfAdew9cY8Sph7Dwzq8JiK5Of4",

  authDomain: "daily-dose-of-positivity-d8e78.firebaseapp.com",

  projectId: "daily-dose-of-positivity-d8e78",

  storageBucket: "daily-dose-of-positivity-d8e78.firebasestorage.app",

  messagingSenderId: "873430812377",

  appId: "1:873430812377:web:177cf4b6c2e48fc17d20c8"

        };
        // -----------------------------------------------------------------------------------


        let db;
        let auth;
        let userId = null;
        let isAuthReady = false;
        
        // This is the ID of the person who first runs the app (the one we are talking to)
        // This user gets special permissions to push messages to the public Vibe.
        let CURATOR_ID = null; 

        let publicVibeMessages = []; // Global array for public messages (for the Shuffle)
        let myPrivateMessages = [];   // Global array for current user's messages (for the List)
        let currentlyEditing = {}; // Tracks which message ID is in edit mode: { messageId: boolean }
        let blockedVibeIds = new Set(); // Stores IDs of messages the current user has blocked

        // Set log level to see Firebase console output
        setLogLevel('Debug');

        /**
         * Initializes Firebase and authenticates the user.
         */
        async function initializeFirebase() {
            let configToUse = firebaseConfig;

            // Check if we are outside the canvas environment (config is empty) and use the user-pasted config
            if (Object.keys(configToUse).length === 0 && Object.keys(USER_FIREBASE_CONFIG).length > 0 && USER_FIREBASE_CONFIG.apiKey !== "YOUR_API_KEY_HERE" && USER_FIREBASE_CONFIG.apiKey !== "") {
                configToUse = USER_FIREBASE_CONFIG;
                console.log("Using USER_FIREBASE_CONFIG for initialization.");
            }
            
            if (Object.keys(configToUse).length === 0 || configToUse.apiKey === "YOUR_API_KEY_HERE" || configToUse.apiKey === "") {
                // Display error message in the UI instead of using alert()
                document.getElementById('message-box').innerHTML = `
                    <p class="text-yellow-400 font-bold">
                        Configuration Error: Public features are disabled until you paste your Firebase config below.
                    </p>`;
                console.error("FIREBASE CONFIG ERROR: The app is missing the required Firebase API keys. Please ensure you are running in the canvas or have pasted your config into the USER_FIREBASE_CONFIG variable.");
                // We stop initialization here to prevent errors when no config is provided outside canvas.
                return;
            }


            try {
                const app = initializeApp(configToUse);
                db = getFirestore(app);
                auth = getAuth(app);

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        isAuthReady = true;
                        
                        // Set the current user as the Curator (for this environment only)
                        if (!CURATOR_ID) {
                            CURATOR_ID = userId;
                        }

                        // Update User ID and Curator status
                        document.getElementById('user-info-display').innerHTML = `
                            User ID: ${userId} 
                            ${(userId === CURATOR_ID) ? '<span class="text-indigo-400 font-bold">(CURATOR)</span>' : ''}
                        `;
                        
                        // Update Shared App ID
                        document.getElementById('app-id-display').textContent = appId;
                        
                        console.log("Authenticated with user ID:", userId);
                        
                        setupListeners();
                    } else {
                        // Attempt to sign in using the provided custom token or anonymously
                        if (initialAuthToken) {
                            await signInWithCustomToken(auth, initialAuthToken);
                        } else {
                            await signInAnonymously(auth);
                        }
                    }
                });
            } catch (error) {
                console.error("Firebase initialization or authentication failed:", error);
                document.getElementById('message-box').innerHTML = `<p class="text-red-600">Error: Could not connect to the database. Check console for details</p>`;
            }
        }

        /**
         * Returns the reference to the PUBLIC VIBE collection.
         */
        function getVibeCollectionRef() {
            if (!db) return null;
            // Public path: /artifacts/{appId}/public/data/vibe_messages
            return collection(db, 'artifacts', appId, 'public', 'data', 'vibe_messages');
        }

        /**
         * Returns the reference to the user's PRIVATE message collection.
         */
        function getPrivateCollectionRef() {
            if (!db || !userId) return null;
            // Private path: /artifacts/{appId}/users/{userId}/my_private_messages
            return collection(db, 'artifacts', appId, 'users', userId, 'my_private_messages');
        }

        /**
         * Seeds the public vibe collection with default messages if it is empty.
         * Only runs if the current user is the Curator.
         */
        async function seedPublicVibe() {
            const defaultMessages = [
                "Your vibe attracts your tribe.",
                "Today is another chance to get it right.",
                "Small progress is still progress.",
                "Be the reason someone smiles today.",
                "You are capable of amazing things.",
                "Choose kindness and laugh often."
            ];
            
            const vibeRef = getVibeCollectionRef();
            if (!vibeRef) return;
            
            console.log("Public Vibe is empty. Seeding with default messages...");
            
            try {
                const promises = defaultMessages.map(text => 
                    addDoc(vibeRef, {
                        text: text,
                        promotedBy: 'system-seed', 
                        promotedAt: new Date()
                    })
                );
                await Promise.all(promises);
                console.log("Default messages added to Public Vibe.");
            } catch (e) {
                console.error("Error seeding public vibe:", e);
                document.getElementById('message-box').innerHTML = `<p class="text-red-400">Error seeding public messages: ${e.message}</p>`;
            }
        }

        /**
         * Sets up real-time listeners for both public, private messages, and user settings.
         */
        function setupListeners() {
            // Listener 1: Public Vibe Messages (for the Shuffle display)
            const vibeRef = getVibeCollectionRef();
            if (vibeRef) {
                onSnapshot(vibeRef, (snapshot) => {
                    publicVibeMessages = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    
                    // NEW: If the public pool is empty and the current user is the Curator, seed it once.
                    if (publicVibeMessages.length === 0 && userId === CURATOR_ID) {
                        seedPublicVibe();
                    }

                    displayRandomMessage(publicVibeMessages); 
                    renderPublicVibeList(publicVibeMessages); 
                }, (error) => {
                    console.error("Error listening to public messages:", error);
                });
            }

            // Listener 2: User's Private Messages (for the Management list)
            const privateRef = getPrivateCollectionRef();
            if (privateRef) {
                onSnapshot(privateRef, (snapshot) => {
                    myPrivateMessages = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    renderPrivateMessagesList(myPrivateMessages); 
                }, (error) => {
                    console.error("Error listening to private messages:", error);
                });
            }
            
            // Listener 3: User's Blocked Messages (Private Settings)
            if (db && userId) {
                const settingsDocRef = doc(db, 'artifacts', appId, 'users', userId, 'user_settings', 'vibe_settings');
                onSnapshot(settingsDocRef, (docSnapshot) => {
                    const data = docSnapshot.data();
                    // Store blockedIds as a Set for efficient lookup
                    const blockedArray = data?.blockedIds || [];
                    blockedVibeIds = new Set(blockedArray); 
                    
                    // After updating the blocked list, refresh the main display
                    displayRandomMessage(publicVibeMessages);
                    
                    // Update the blocked count display
                    document.getElementById('blocked-count-display').textContent = blockedVibeIds.size;
                }, (error) => {
                    console.error("Error listening to user settings:", error);
                });
            }
        }

        /**
         * Displays a single random message prominently at the top of the app, filtering blocked messages.
         */
        function displayRandomMessage(messages) {
            const displayElement = document.getElementById('random-message-display');
            const controlElement = document.getElementById('random-message-controls');

            // 1. Filter out blocked messages
            const availableMessages = messages.filter(msg => !blockedVibeIds.has(msg.id));
            
            let randomMessage = null;
            let messageId = null;

            if (availableMessages.length === 0) {
                displayElement.innerHTML = `<p class="text-center text-xl font-medium text-slate-300">
                    The Vibe Pool is empty, or you have blocked all available sayings! 
                    <br><span class="text-sm">Try resetting your blocked list below.</span>
                </p>`;
                controlElement.innerHTML = ''; // Hide controls if nothing is available
                return;
            }
            
            const randomIndex = Math.floor(Math.random() * availableMessages.length);
            randomMessage = availableMessages[randomIndex];
            messageId = randomMessage.id;

            displayElement.innerHTML = `
                <div class="text-center">
                    <p class="text-3xl font-extrabold text-white mb-4 tracking-tight leading-snug">
                        ${randomMessage.text}
                    </p>
                    <p class="text-sm text-indigo-200 font-semibold uppercase opacity-90">
                        Public Vibe Message
                    </p>
                </div>
            `;
            
            // Update the controls area with the Shuffle and Block buttons
            controlElement.innerHTML = `
                <div class="flex flex-col sm:flex-row justify-center space-y-3 sm:space-y-0 sm:space-x-4">
                    <button
                        onclick="showNewMessage()"
                        class="bg-yellow-400 text-slate-900 font-semibold py-2 px-6 rounded-full hover:bg-yellow-500 transition duration-150 shadow-xl shadow-yellow-400/50 active:scale-95 transform"
                    >
                        Shuffle Vibe
                    </button>
                    <button
                        onclick="blockCurrentMessage('${messageId}')"
                        class="bg-slate-500 text-white font-semibold py-2 px-6 rounded-full hover:bg-slate-600 transition duration-150 active:scale-95 transform text-sm sm:text-base"
                        title="Block this message from appearing again for you."
                    >
                        Block Saying
                    </button>
                </div>
            `;
        }
        
        // Helper function to trigger a new message display
        window.showNewMessage = function() {
            displayRandomMessage(publicVibeMessages);
        }

        /**
         * Adds the currently displayed message ID to the user's private blocked list.
         */
        window.blockCurrentMessage = async function(id) {
            if (!isAuthReady) {
                 document.getElementById('message-box').innerHTML = `<p class="text-red-400">Please wait for authentication to complete.</p>`;
                setTimeout(() => document.getElementById('message-box').innerHTML = '', 3000);
                return;
            }
            
            if (blockedVibeIds.has(id)) {
                document.getElementById('message-box').innerHTML = `<p class="text-yellow-400">This message is already blocked.</p>`;
                setTimeout(() => document.getElementById('message-box').innerHTML = '', 3000);
                return;
            }

            try {
                const settingsDocRef = doc(db, 'artifacts', appId, 'users', userId, 'user_settings', 'vibe_settings');
                
                // Get the current list and add the new ID
                const newBlockedIds = Array.from(blockedVibeIds);
                newBlockedIds.push(id);

                await setDoc(settingsDocRef, { blockedIds: newBlockedIds }, { merge: true });
                document.getElementById('message-box').innerHTML = `<p class="text-green-400">Message blocked! Shuffling to a new vibe...</p>`;
                setTimeout(() => document.getElementById('message-box').innerHTML = '', 3000);
                
                // The onSnapshot listener will handle the display update
            } catch (e) {
                console.error("Error blocking message: ", e);
                document.getElementById('message-box').innerHTML = `<p class="text-red-400">Error blocking message: ${e.message}</p>`;
            }
        }
        
        /**
         * Clears the user's private blocked message list.
         */
        window.resetBlockedList = async function() {
             if (!isAuthReady) {
                 document.getElementById('message-box').innerHTML = `<p class="text-red-400">Please wait for authentication to complete.</p>`;
                setTimeout(() => document.getElementById('message-box').innerHTML = '', 3000);
                return;
            }
            try {
                const settingsDocRef = doc(db, 'artifacts', appId, 'users', userId, 'user_settings', 'vibe_settings');
                await setDoc(settingsDocRef, { blockedIds: [] }); // Overwrite with empty array
                document.getElementById('message-box').innerHTML = `<p class="text-green-400">Blocked list reset! All messages are back in rotation.</p>`;
                setTimeout(() => document.getElementById('message-box').innerHTML = '', 4000);
            } catch (e) {
                console.error("Error resetting blocked list: ", e);
                document.getElementById('message-box').innerHTML = `<p class="text-red-400">Error resetting blocked list: ${e.message}</p>`;
            }
        }

        /**
         * Renders the list of messages added by the current user only (from their private collection).
         */
        function renderPrivateMessagesList(messages) {
            const listElement = document.getElementById('message-list');
            listElement.innerHTML = ''; // Clear existing list

            if (messages.length === 0) {
                listElement.innerHTML = '<p class="text-slate-400 text-center py-4">Your Private Scratchpad is empty. Add a message!</p>';
                return;
            }

            messages.sort((a, b) => b.createdAt.toDate() - a.createdAt.toDate());

            messages.forEach(message => {
                const isPromoted = publicVibeMessages.some(vibeMsg => vibeMsg.text === message.text);
                const isEditing = currentlyEditing[message.id]; // Check local edit state
                
                const item = document.createElement('div');
                // Updated promoted background/border to Gold
                item.className = 'list-item flex flex-col md:flex-row items-start md:items-center justify-between p-3 mb-2 bg-slate-700 rounded-lg shadow-md transition duration-150 border ' + (isPromoted ? 'border-yellow-400 bg-slate-600' : 'border-slate-700');
                
                // Updated badge colors
                const statusBadge = isPromoted 
                    ? `<span class="text-xs font-bold text-yellow-200 bg-yellow-700 rounded-full px-2 py-0.5 mr-2">PUBLIC VIBE</span>`
                    : `<span class="text-xs font-medium text-slate-400 bg-slate-600 rounded-full px-2 py-0.5 mr-2">PRIVATE</span>`;

                item.innerHTML = `
                    <div class="flex-grow truncate mr-4 w-full md:w-auto mb-2 md:mb-0">
                        ${statusBadge} 
                        
                        <!-- Static Text Display (Hidden when editing) -->
                        <span id="text-display-${message.id}" class="text-slate-100 text-sm break-words ${isEditing ? 'hidden' : ''}">
                            ${message.text}
                        </span>
                        
                        <!-- Editable Input Field (Visible when editing) -->
                        <textarea 
                            id="edit-input-${message.id}" 
                            class="w-full text-slate-900 text-sm p-2 rounded-lg bg-white border border-yellow-400 resize-none h-auto transition duration-150 ${isEditing ? '' : 'hidden'}"
                            rows="2"
                        >${message.text}</textarea>
                    </div>

                    <div class="flex space-x-2 flex-shrink-0 mt-2 md:mt-0">
                        
                        <!-- SAVE Button (Visible only when editing) -->
                        <button
                            id="save-btn-${message.id}"
                            onclick="saveEdit('${message.id}')"
                            class="bg-green-500 text-white text-xs font-semibold py-1 px-3 rounded-full hover:bg-green-600 transition duration-150 active:scale-95 transform ${isEditing ? '' : 'hidden'}"
                            title="Save Changes"
                        >
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-check"><path d="M20 6 9 17l-5-5"/></svg>
                        </button>

                        <!-- EDIT Button (Visible only when NOT editing) -->
                        <button
                            id="edit-btn-${message.id}"
                            onclick="toggleEdit('${message.id}')"
                            class="bg-indigo-500 text-white text-xs font-semibold py-1 px-3 rounded-full hover:bg-indigo-600 transition duration-150 active:scale-95 transform ${isEditing ? 'hidden' : ''}"
                            title="Edit Private Message"
                        >
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-pencil"><path d="M17 3a2.85 2.85 0 0 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/></svg>
                        </button>
                        
                        <!-- Promote Button (Hidden while editing) -->
                        ${(userId === CURATOR_ID && !isPromoted && !isEditing) ? `
                            <button
                                onclick="promoteToVibe('${message.id}', '${message.text.replace(/'/g, "\\'")}')"
                                class="bg-red-500 text-white text-xs font-semibold py-1 px-3 rounded-full hover:bg-red-600 transition duration-150 active:scale-95 transform"
                                title="Add to the community Vibe pool"
                            >
                                Promote
                            </button>` : ''}
                        
                        <!-- Delete Button (Hidden while editing) -->
                        <button
                            onclick="deletePrivateMessage('${message.id}')"
                            class="text-red-400 hover:text-red-300 p-1 rounded-full transition duration-150 ${isEditing ? 'hidden' : ''}"
                            title="Delete Private Message"
                        >
                            <!-- SVG trash icon -->
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-trash-2"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></svg>
                        </button>
                    </div>
                `;
                listElement.appendChild(item);
            });
            
            // Auto-resize visible text areas immediately after rendering
             setTimeout(() => {
                document.querySelectorAll('textarea').forEach(textarea => {
                    if (!textarea.classList.contains('hidden')) {
                         textarea.style.height = 'auto'; 
                         textarea.style.height = (textarea.scrollHeight) + 'px';
                    }
                });
            }, 0);
        }
        
        /**
         * Renders the list of all PUBLIC VIBE messages (Curator's management view).
         */
        function renderPublicVibeList(messages) {
            const containerElement = document.getElementById('public-vibe-container');
            const listElement = document.getElementById('public-message-list');
            
            // Only show this section if the user is the Curator
            if (userId !== CURATOR_ID) {
                containerElement.classList.add('hidden');
                return;
            }
            
            containerElement.classList.remove('hidden');

            listElement.innerHTML = ''; // Clear existing list
            
            // Update the message count header
            const header = containerElement.querySelector('p.text-sm');
            if (header) {
                 header.innerHTML = `This list shows all **${messages.length}** sayings currently in rotation for everyone.`;
            }


            if (messages.length === 0) {
                listElement.innerHTML = '<p class="text-slate-400 text-center py-4">The Public Vibe Pool is currently empty.</p>';
                return;
            }

            // Sort by promotion date/time (newest first)
            messages.sort((a, b) => {
                // Handle cases where 'promotedAt' might be missing (for very old data or errors)
                const dateA = b.promotedAt ? b.promotedAt.toDate() : new Date(0);
                const dateB = a.promotedAt ? a.promotedAt.toDate() : new Date(0);
                return dateA - dateB;
            });

            messages.forEach(message => {
                const item = document.createElement('div');
                item.className = 'list-item flex flex-col md:flex-row items-start md:items-center justify-between p-3 mb-2 bg-slate-700 rounded-lg shadow-md border border-yellow-400/50';
                
                // Truncate the ID for display purposes
                const shortId = message.id.substring(0, 6);
                
                // Format the promotion date (or provide a fallback)
                const promotedAtDate = message.promotedAt ? message.promotedAt.toDate().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) + ', ' + message.promotedAt.toDate().toLocaleDateString() : 'N/A';


                item.innerHTML = `
                    <div class="flex-grow truncate mr-4 w-full md:w-auto mb-2 md:mb-0">
                        <span class="text-xs font-bold text-yellow-200 bg-yellow-700 rounded-full px-2 py-0.5 mr-2">VIBE ID: ${shortId}</span> 
                        <span class="text-slate-100 text-sm break-words">
                            ${message.text}
                        </span>
                        <p class="text-xs text-slate-400 mt-1">Promoted At: ${promotedAtDate}</p>
                    </div>

                    <div class="flex space-x-2 flex-shrink-0 mt-2 md:mt-0">
                        <!-- Delete Public Button -->
                        <button
                            onclick="deletePublicMessage('${message.id}')"
                            class="bg-red-700 text-white text-xs font-semibold py-1 px-3 rounded-full hover:bg-red-800 transition duration-150 active:scale-95 transform"
                            title="Remove this message from the Public Vibe Pool"
                        >
                            Delete Public
                        </button>
                    </div>
                `;
                listElement.appendChild(item);
            });
        }


        /**
         * Adds a new message to the user's PRIVATE collection.
         */
        window.addMessage = async function() {
            const input = document.getElementById('message-input');
            const messageText = input.value.trim();

            if (!isAuthReady) {
                document.getElementById('message-box').innerHTML = `<p class="text-red-400">Authentication is not ready. Please wait a moment.</p>`;
                return;
            }

            if (messageText === "") {
                document.getElementById('message-box').innerHTML = `<p class="text-red-400">Please enter a message.</p>`;
                setTimeout(() => document.getElementById('message-box').innerHTML = '', 3000);
                return;
            }

            try {
                const privateRef = getPrivateCollectionRef();
                await addDoc(privateRef, {
                    text: messageText,
                    addedBy: userId, 
                    createdAt: new Date()
                });
                input.value = ''; // Clear input
                document.getElementById('message-box').innerHTML = `<p class="text-green-400">Message saved to your Private Scratchpad!</p>`;
                setTimeout(() => document.getElementById('message-box').innerHTML = '', 3000);
            } catch (e) {
                console.error("Error adding document: ", e);
                document.getElementById('message-box').innerHTML = `<p class="text-red-400">Error adding message: ${e.message}</p>`;
            }
        }

        /**
         * Deletes a message from the user's PRIVATE collection.
         */
        window.deletePrivateMessage = async function(id) {
            if (!isAuthReady) return;
            try {
                const privateRef = getPrivateCollectionRef();
                const messageDocRef = doc(privateRef, id);
                await deleteDoc(messageDocRef);
                document.getElementById('message-box').innerHTML = `<p class="text-green-400">Message deleted from your private list.</p>`;
                setTimeout(() => document.getElementById('message-box').innerHTML = '', 3000);
            } catch (e) {
                console.error("Error deleting document: ", e);
                document.getElementById('message-box').innerHTML = `<p class="text-red-400">Error deleting message: ${e.message}</p>`;
            }
        }
        
        /**
         * Deletes a message from the PUBLIC VIBE collection. Only for the Curator.
         */
        window.deletePublicMessage = async function(id) {
            if (userId !== CURATOR_ID) {
                document.getElementById('message-box').innerHTML = `<p class="text-red-400">Error: Only the Curator can delete public messages.</p>`;
                setTimeout(() => document.getElementById('message-box').innerHTML = '', 4000);
                return;
            }
            try {
                const vibeRef = getVibeCollectionRef();
                const messageDocRef = doc(vibeRef, id);
                await deleteDoc(messageDocRef);
                document.getElementById('message-box').innerHTML = `<p class="text-green-400">Public Vibe message deleted successfully!</p>`;
                setTimeout(() => document.getElementById('message-box').innerHTML = '', 3000);
            } catch (e) {
                console.error("Error deleting public document: ", e);
                document.getElementById('message-box').innerHTML = `<p class="text-red-400">Error deleting public message: ${e.message}</p>`;
            }
        }

        /**
         * Updates a message in the user's PRIVATE collection.
         */
        window.updatePrivateMessage = async function(id, newText) {
            if (!isAuthReady || newText.trim() === "") {
                document.getElementById('message-box').innerHTML = `<p class="text-red-400">Message cannot be empty.</p>`;
                setTimeout(() => document.getElementById('message-box').innerHTML = '', 3000);
                return;
            }

            try {
                const privateRef = getPrivateCollectionRef();
                const messageDocRef = doc(privateRef, id);
                
                // Use setDoc to update the 'text' field
                await setDoc(messageDocRef, { text: newText.trim() }, { merge: true });

                // Exit edit mode on successful save
                delete currentlyEditing[id]; 
                
                document.getElementById('message-box').innerHTML = `<p class="text-green-400">Message updated successfully!</p>`;
                setTimeout(() => document.getElementById('message-box').innerHTML = '', 3000);
                
                // The onSnapshot listener will trigger renderPrivateMessagesList() automatically
            } catch (e) {
                console.error("Error updating document: ", e);
                document.getElementById('message-box').innerHTML = `<p class="text-red-400">Error updating message: ${e.message}</p>`;
            }
        }
        
        /**
         * Toggles the editing state for a single message and triggers a re-render.
         */
        window.toggleEdit = function(id) {
            if (currentlyEditing[id]) {
                // Cancel editing
                delete currentlyEditing[id];
            } else {
                // Start editing
                currentlyEditing[id] = true;
            }
            
            // Manually trigger a re-render to apply the new state classes
            renderPrivateMessagesList(myPrivateMessages);
        }

        /**
         * Handles reading the input field and calling the update function.
         */
        window.saveEdit = function(id) {
            const inputElement = document.getElementById(`edit-input-${id}`);
            const newText = inputElement ? inputElement.value : '';
            
            if (newText.trim()) {
                window.updatePrivateMessage(id, newText);
            } else {
                document.getElementById('message-box').innerHTML = `<p class="text-red-400">Cannot save an empty message.</p>`;
                setTimeout(() => document.getElementById('message-box').innerHTML = '', 3000);
            }
        }

        /**
         * Copies a message from the Curator's private list to the PUBLIC VIBE pool.
         */
        window.promoteToVibe = async function(id, text) {
            if (userId !== CURATOR_ID) {
                document.getElementById('message-box').innerHTML = `<p class="text-red-400">Error: Only the Curator can promote messages.</p>`;
                setTimeout(() => document.getElementById('message-box').innerHTML = '', 4000);
                return;
            }
            
            try {
                const vibeRef = getVibeCollectionRef();
                // We use addDoc here to create a new, distinct document in the public collection.
                await addDoc(vibeRef, {
                    text: text,
                    promotedBy: userId, 
                    promotedAt: new Date()
                });
                document.getElementById('message-box').innerHTML = `<p class="text-green-400">Message promoted to the Public Vibe Pool!</p>`;
                setTimeout(() => document.getElementById('message-box').innerHTML = '', 3000);
            } catch (e) {
                console.error("Error promoting message: ", e);
                document.getElementById('message-box').innerHTML = `<p class="text-red-400">Error promoting message: ${e.message}</p>`;
            }
        }
        
        // --- Initialization ---
        window.onload = initializeFirebase;
    </script>
</head>
<body class="p-4 sm:p-8">

    <div class="w-full max-w-4xl space-y-8">
        <h1 class="text-4xl sm:text-5xl font-extrabold text-white text-center tracking-tight">Community Vibe Generator</h1>
        
        <div class="text-center bg-slate-700/50 p-3 rounded-xl border border-slate-600 text-sm text-slate-400">
            <span id="user-info-display">Connecting to Vibe network...</span> | 
            App ID: <span id="app-id-display">N/A</span>
        </div>

        <!-- Main Display Card -->
        <div class="message-card p-6 sm:p-10 rounded-3xl w-full">
            <h2 class="text-xl text-center font-bold text-white mb-6">Your Daily Dose of Community Positivity</h2>
            
            <div id="random-message-display" class="min-h-[150px] flex items-center justify-center">
                <p class="text-center text-xl font-medium text-slate-300">Loading the Public Vibe...</p>
            </div>
            
            <div id="random-message-controls" class="mt-8">
                <!-- Shuffle and Block buttons will be rendered here -->
            </div>
            
            <div class="text-center mt-6 text-sm">
                <p class="text-indigo-200">
                    <span id="blocked-count-display" class="font-bold">0</span> sayings blocked. 
                    <button onclick="resetBlockedList()" class="underline hover:text-yellow-300 transition duration-150">Reset blocked list?</button>
                </p>
            </div>
        </div>

        <!-- Add New Message Section -->
        <div class="bg-slate-800 p-6 rounded-2xl shadow-lg border border-slate-700">
            <h2 class="text-2xl font-semibold text-white mb-4">Add a New Message (Private Scratchpad)</h2>
            <div class="flex flex-col sm:flex-row space-y-3 sm:space-y-0 sm:space-x-3">
                <textarea 
                    id="message-input" 
                    placeholder="Enter a positive quote or mantra..." 
                    class="flex-grow p-3 rounded-lg text-slate-900 bg-white border border-slate-600 focus:ring-indigo-500 focus:border-indigo-500 transition duration-200 resize-none h-20 sm:h-auto"
                ></textarea>
                <button
                    onclick="addMessage()"
                    class="bg-indigo-600 text-white font-bold py-3 px-6 rounded-xl hover:bg-indigo-700 transition duration-150 shadow-md shadow-indigo-600/50 active:scale-95 transform whitespace-nowrap"
                >
                    Save to Scratchpad
                </button>
            </div>
            <div id="message-box" class="mt-2 h-6 text-center text-sm font-medium"></div>
        </div>

        <!-- Private Messages List Section -->
        <div class="bg-slate-800 p-6 rounded-2xl shadow-lg border border-slate-700">
            <h2 class="text-2xl font-semibold text-white mb-4">Your Private Scratchpad</h2>
            <div id="message-list" class="space-y-3 max-h-96 overflow-y-auto">
                <!-- Private messages will be rendered here -->
            </div>
        </div>
        
        <!-- Curator Management Section (Hidden unless user is the Curator) -->
        <div id="public-vibe-container" class="bg-slate-800 p-6 rounded-2xl shadow-lg border border-yellow-500/50 hidden">
            <h2 class="text-2xl font-semibold text-white mb-2">Public Vibe Management (Curator)</h2>
            <p class="text-sm text-yellow-400 mb-4">This list shows all sayings currently in rotation for everyone.</p>
            <div id="public-message-list" class="space-y-3 max-h-96 overflow-y-auto">
                <!-- Public messages will be rendered here -->
            </div>
        </div>
        
    </div>
</body>
</html>
